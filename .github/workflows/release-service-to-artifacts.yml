name: 'Build, Test, and Release Updates to Google Artifact Registry'

on:
  workflow_dispatch:
  push: 
    tags: 
      - '*' # Workflow is trigered when a push is made with a tag

jobs:
  # Job 1: Check that the release version is correct
  well-tag-triggered-job:
    name: 'Check tag'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    env:
      TZ: Europe/Madrid  # Set the timezone to your local timezone
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      # Step 1: Clone the source repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Display tag information
      - name: Get Tag Details
        run: |
          echo "Tag Name: ${{ github.ref_name }}"
          echo "Full Reference: ${{ github.ref }}"
          echo "Event: ${{ github.event_name }}"

          ## Changing the variable name for the tag
          echo "tag=${{github.ref_name}}">>$GITHUB_ENV
          echo "The Tag name is ${{env.tag}}"

      # Step 3: Validate the Tag Format (Date and Commit SHA)
      - name: Validate the Tag Format (Date and Commit SHA)
        run: |
          # Extracting the current date in YYYY.MM.DD format
          current_date=$(date -u +"%Y.%m.%d")  # ✅ Fixed date format
          echo "Current Date: $current_date"

          # Extract commit hash of HEAD
          commit_hash=$(git rev-parse --short HEAD)
          echo "Current Commit Hash: $commit_hash"

          # Extract date and commit from the tag
          tag="${{ env.tag }}"  # ✅ Ensure env variable reference is correct
          echo "Validating Tag: $tag"

          # ✅ Regex to check tag format: vYYYY.MM.DD+shaabcdefg
          if [[ "$tag" =~ ^v([0-9]{4}\.[0-9]{2}\.[0-9]{2})\+sha([a-f0-9]+)$ ]]; then
            tag_date="${BASH_REMATCH[1]}"
            tag_commit="${BASH_REMATCH[2]}"

            echo "Extracted Tag Date: $tag_date"
            echo "Extracted Tag Commit Hash: $tag_commit"

            # Compare extracted date with current :
            if [[ "$tag_date" != "$current_date" ]]; then
              echo "❌ ERROR: Tag date ($tag_date) does not match today's date ($current_date)!"
              exit 1
            fi

            # Compare extracted commit hash with actual commit hash
            if [[ "$tag_commit" != "$commit_hash" ]]; then
              echo "❌ ERROR: Tag commit hash ($tag_commit) does not match the current commit ($commit_hash)!"
              exit 1
            fi

            echo "✅ Tag validation successful!"
          else
            echo "❌ ERROR: Tag format is incorrect! Expected format: vYYYY.MM.DD+shaabcdefg"
            exit 1
          fi

  # Job 2: Job for uploading a release to GitHub and an artifact to GAR
  uploading-release-to-GitHub-and_GAR:
    name: 'Making release to GitHub and GAR'
    runs-on: ubuntu-latest
    needs: well-tag-triggered-job
    permissions:
      contents: write
      id-token: write
    env:
      TZ: Europe/Madrid  # Set the timezone to your local timezone
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps: 

      # Step 1: Clone the source repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Install Go
      - name: Setting up Golang
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      # Step 3: Build all Go files
      - name: Build All Go Files
        id: build_step
        run: |
          echo "Building all Go files in the directory..."
          mkdir -p build
          find . -type f -name "*.go" | while read -r file; do
            echo "Building $file..."
            output_name=$(basename "$file" .go)
            go build -o "build/$output_name" "$file"
          done

      # Step 4: Show Build Results
      - name: List Build Output
        run: |
          echo "Build outputs:"
          ls -lh build/

      # Step 5: Simulating that some testing are done 
      - name: Simulating that some testings and checks are done
        run: |
          # Getting the tag name
          echo "tag=${{github.ref_name}}">>$GITHUB_ENV
          echo "Simulating that some testings and checks are done"
          
      # Step 6: Compress Build Artifacts
      - name: Compress Build Artifacts
        run: |
          service_name=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)
          zip_name="${service_name}.zip"
          echo "zip_name=$zip_name" >> $GITHUB_ENV
          zip -r "$zip_name" build/
      
      # Step 7: Compute the SHA256
      - name: Compute the SHA256 of the .zip
        run: |
          echo "Computing SHA256 checksum of the .zip"
          digest=$(sha256sum "${{ env.zip_name }}" | awk '{ print $1 }')
          echo "digest=$digest" >> $GITHUB_ENV
          echo "SHA256 checksum is: $digest"
        
      # Step 8: Verifying GitHub Token
      - name: Verify GITHUB_TOKEN
        run: |
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
              echo "Error: GITHUB_TOKEN is not set."
              exit 1
          else
              echo "GITHUB_TOKEN is available."
          fi
      # Step 9: Create a release
      - name: Create a GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.tag }}
          release_name: "Tunnel-integration ${{ env.tag }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            Release generated by GitHub Actions.
            This includes the build artifacts of the service.
          draft: false
          prerelease: false

      # Step 10: Upload the ZIP file as a release asset
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ env.zip_name }}
          asset_name: ${{ env.zip_name }}
          asset_content_type: application/zip
          
      # Step 11: Login to Google Cloud Registry
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with: 
          token_format: access_token
          workload_identity_provider: projects/185640679849/locations/global/workloadIdentityPools/github/providers/github-prov
          service_account: github-actions-auth@polished-medium-445107-i9.iam.gserviceaccount.com
          access_token_lifetime: '600s'

      # Step 12: Setting envirnment variables
      - name: Set Environment Variables
        run: |
          echo "Setting environment variables..."
          echo "service_name=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f2)" >> $GITHUB_ENV
          version_fixed=$(echo "${{ env.tag }}" | tr '+' '-')
          echo "version_fixed=$version_fixed" >> $GITHUB_ENV

          echo "Service Name: $service_name"
          echo "Version Fixed: $version_fixed"

      # Step 13: Upload each built artifact to Google Artifact Registry
      - name: Upload build artifacts to Google Artifact Registry
        id: pushing-GAR
        run: |
          echo "Uploading each built artifact to Google Artifact Registry..."
          echo "Uploading service name ${{ env.service_name }}"

          echo "Original version: ${{ env.tag }}"
          echo "Modified version: ${{ env.version_fixed }}"

          for file in build/*; do
            artifact_name=$(basename "$file")
            echo "Processing artifact: $artifact_name"

            gcloud artifacts generic upload \
              --repository=nebula-storage \
              --location=europe-southwest1 \
              --project=polished-medium-445107-i9 \
              --package="${{ env.service_name }}" \
              --version="${{ env.version_fixed }}" \
              --source="$file"

            echo "Uploaded $artifact_name to Google Artifact Registry"
          done

          echo "Successfully uploaded all artifacts to Google Artifact Registry"

      # Step 14: Verifying that the SHA from GitHub Releases matches the SHA from GAR
      - name: Verifying the SHAs from GitHub Releases match the SHA from GAR
        id: verifying-digests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Step 13: Verifying SHA256 checksums between GitHub Release and Google Artifact Registry"

          # Fetch the digest from Google Artifact Registry (GAR)
          echo "Fetching digest from GAR..."
          gar_digest=$(gcloud artifacts versions describe "${{ env.version_fixed }}" \
            --package="${{ env.service_name }}" \
            --repository=nebula-storage \
            --location=europe-southwest1 \
            --format='value(digest)')
          
          if [ -z "$gar_digest" ]; then
            echo "Error: Failed to retrieve digest from GAR"
            exit 1
          fi

          echo "GAR SHA256 Digest: $gar_digest"
          echo "gar_digest=$gar_digest" >> $GITHUB_ENV

          # Download the release asset from GitHub
          echo "Downloading the GitHub release artifact..."
          gh release download --repo sorayaormazabalmayo/tunnel-integration \
            --pattern "${{ env.zip_name }}" --dir .

          # Extract the ZIP file
          echo "Unzipping the GitHub release artifact..."
          unzip -o "${{ env.zip_name }}" -d extracted_release

          # Compute SHA256 for each uncompressed file in the extracted folder
          echo "Computing SHA256 of extracted files..."
          release_file=$(find extracted_release/ -type f | head -n 1)  # Pick the first file
          github_release_sha256=$(sha256sum "$release_file" | awk '{ print $1 }')

          if [ -z "$github_release_sha256" ]; then
            echo "Error: Failed to compute SHA256 of the extracted file"
            exit 1
          fi

          echo "GitHub Release SHA256: $github_release_sha256"
          echo "github_release_sha256=$github_release_sha256" >> $GITHUB_ENV

          # Compare SHA256 checksums
          echo "Comparing SHA256 digests..."
          if [ "$gar_digest" != "$github_release_sha256" ]; then
            echo "Error: The SHA256 digests do NOT match!"
            exit 1
          else
            echo "Success: The SHA256 digests match! ✅"
          fi




  
    


